!function(a){"use strict";a.fn.megaMenu=function(b){var c=a("<div/>");c.settings=a.extend({cols:6,menu_item_id:0,menu_item_title:"",menu_item_depth:0},b);var d=a(".popup-wrapper_"),e="id-"+c.settings.menu_item_id,f=!1;0===a("#"+e).length&&d.append('<div id="'+e+'" class="white-popup-block tm-ui-core"><div class="popup-content_"><div class="popup-loading_"></div></div></div>'),c.init=function(){a.magnificPopup.open({items:{src:"#"+e},type:"inline",callbacks:{open:function(){h()}}}),a(document).on("click",".tm-mega-menu-save-settings",function(b){b.preventDefault(),g(a(this))}).on("change",".toggle_menu",function(b){g(a(this))})};var g=function(b){var c=b.parents("form"),d=c.serialize();k(),a.post(ajaxurl,d,function(a){l()})},h=function(){var b=a("#"+e+" .popup-content_"),d={action:"tm_mega_menu_get_popup",_wpnonce:tm_mega_menu.nonce,menu_item_id:c.settings.menu_item_id,menu_item_title:c.settings.menu_item_title,menu_item_depth:c.settings.menu_item_depth,total_cols:c.settings.cols};a.ajax({type:"POST",url:ajaxurl,data:d,cache:!1,beforeSend:function(){b.html('<div class="popup-loading_"></div>')},complete:function(){b.find(".popup-loading_").remove()},success:function(d){var f=d.content;b.addClass("depth-"+c.settings.menu_item_depth).html(f).on("click.tm_mega_menu_tabs",".vertical-tabs_.vertical-tabs_width_small_ a",function(b){b.preventDefault(),a(this).parent().addClass("active").siblings().removeClass("active"),a(this).parents(".popup-content_").find(".mega-menu-tabs-content_").find("#"+a(this).data("tab")).css("visibility","visible").siblings().css("visibility","hidden"),j()}),a("#"+e+" .popup-content_ .vertical-tabs_.vertical-tabs_width_small_active a:first").trigger("click.tm_mega_menu_tabs"),i(),j(),a("#"+e+" #tm-mega-menu-tab-mega_menu").length&&(n(),m())}})},i=function(){var b=0;a("#"+e+" .mega-menu-tabs-content-item_").each(function(){var c=a(this).outerHeight();c>b&&(b=c)}),a("#"+e+" .mega-menu-tabs-content_").height(b)},j=function(){a('input[data-init-script="icon-picker"]').each(function(){a(this).iconpicker({iconBaseClass:"fa",iconClassPrefix:"",fullClassFormatter:function(a){return"fa "+a}})})},k=function(){a(".popup-saving_").show()},l=function(){a(".popup-saving_").hide();var b=!1;b||(a(".popup-saved_").stop().fadeIn("fast"),b=setTimeout(function(){a(".popup-saved_").stop().fadeOut("fast")},1e3))},m=function(){var b=a("#"+e).find("#widgets");b.sortable({forcePlaceholderSize:!0,placeholder:"drop-area",start:function(b,c){a(".widget").removeClass("open"),c.item.data("start_pos",c.item.index())},stop:function(a,b){b.item.removeAttr("style"),b.item.data("start_pos")!==b.item.index()&&b.item.trigger("on_drop")}}),a(".widget",b).each(function(){o(a(this))})},n=function(){f=a("#"+e).find("#widget_selector"),f.on("mouseup",function(){var b=a(this);if("disabled"!=b.val()&&void 0!==b.val()){k();var d={action:"tm_mega_menu_add_widget",id_base:b.val(),menu_item_id:c.settings.menu_item_id,total_cols:c.settings.cols,title:b.find("option:selected").text(),_wpnonce:tm_mega_menu.nonce};a.post(ajaxurl,d,function(b){l(),a(".no_widgets").hide(),a("#widgets").append(b.content),i(),"success"==b.type&&o(a("#"+e+" #"+b.id)),f.val("disabled")})}})},o=function(b){var d=b.find(".spinner"),e=b.data("widget-id"),f=tm_mega_menu.nonce;return b.on("on_drop",function(){k();var b={action:"tm_mega_menu_move_widget",widget_id:e,position:a(this).index(),menu_item_id:c.settings.menu_item_id,_wpnonce:f};a.post(ajaxurl,b,function(a){l()})}),b.find(".widget-resize").on("click",function(){var d=b.data("columns"),g=a(this).data("action");"expand"==g&&d<c.settings.cols&&d++,"contract"==g&&1<d&&d--,b.data("columns",d).attr("data-columns",d).find(".widget-cols-counter b").html(d),k();var h={action:"tm_mega_menu_update_columns",widget_id:e,columns:d,_wpnonce:f};a.post(ajaxurl,h,function(a){l()})}),b.find(".widget-edit").on("click",function(){if(b.hasClass("open")||b.data("loaded"))b.toggleClass("open");else{d.show();var c={action:"tm_mega_menu_edit_widget",widget_id:e,_wpnonce:f};a.post(ajaxurl,c,function(c){var f=a(c);a(".delete",f).on("click",function(c){c.preventDefault();var d={action:"tm_mega_menu_delete_widget",widget_id:e,_wpnonce:tm_mega_menu.nonce};a.post(ajaxurl,d,function(a){b.remove()})}),a(".close",f).on("click",function(a){a.preventDefault(),b.toggleClass("open")}),f.on("submit",function(b){b.preventDefault();var c=a(this).serialize();k(),a.post(ajaxurl,c,function(a){l()})}),b.data("loaded",!0).toggleClass("open").find(".widget-inner").html(f),d.hide(),a(document).trigger("widget-added",[b])})}a(".widget").not(b).removeClass("open")}),b};c.init()},a("#menu-to-edit").on("sortstop",function(a,b){setTimeout(function(){b.item.find(".tm-mega-menu-launch").data("depth",b.item.menuItemDepth())},100)}),a(".menu-item").each(function(b){a(this);a(this).find(".tm-mega-menu-launch").on("click",function(b){a(this).megaMenu({cols:tm_mega_menu.cols,menu_item_id:a(this).data("id"),menu_item_title:a(this).data("title"),menu_item_depth:a(this).data("depth")})})})}(jQuery);