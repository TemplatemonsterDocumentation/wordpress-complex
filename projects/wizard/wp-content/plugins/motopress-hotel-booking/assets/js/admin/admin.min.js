!function(e){MPHB.Plugin=can.Construct.extend({myThis:null},{data:null,init:function(t,i){MPHB.Plugin.myThis=this,this.data=MPHB._data,delete MPHB._data;var r=e(".mphb-ctrl:not([data-inited])");this.setControls(r)},getVersion:function(){return this.data.version},getPrefix:function(){return this.data.prefix},addPrefix:function(e,t){return t="undefined"!=typeof t?t:"-",this.getPrefix()+t+e},setControls:function(t){var i,r;e.each(t,function(){switch(r=e(this).attr("data-type")){case"text":break;case"number":break;case"total-price":i=new MPHB.TotalPriceCtrl(e(this));break;case"gallery":i=new MPHB.GalleryCtrl(e(this));break;case"datepicker":i=new MPHB.DatePickerCtrl(e(this));break;case"color-picker":i=new MPHB.ColorPickerCtrl(e(this));break;case"complex":i=new MPHB.ComplexCtrl(e(this));break;case"complex-vertical":i=new MPHB.ComplexVerticalCtrl(e(this));break;case"dynamic-select":i=new MPHB.DynamicSelectCtrl(e(this))}e(this).attr("data-inited",!0)})}}),MPHB.WPGallery=can.Construct.extend({myThis:null,getInstance:function(){return null===MPHB.WPGallery.myThis&&(MPHB.WPGallery.myThis=new MPHB.WPGallery),MPHB.WPGallery.myThis}},{frame:null,ctrl:null,init:function(){MPHB.WPGallery.myThis=this,Attachment=wp.media.model.Attachment,wp.media.controller.MPHBGallery=wp.media.controller.FeaturedImage.extend({defaults:parent._.defaults({id:"mphb-media-library-gallery",title:MPHB.Plugin.myThis.data.translations.roomTypeGalleryTitle,toolbar:"main-insert",filterable:"uploaded",library:wp.media.query({type:"image"}),multiple:"add",editable:!0,priority:60,syncSelection:!1},wp.media.controller.Library.prototype.defaults),updateSelection:function(){var e,t=this.get("selection"),i=MPHB.WPGallery.myThis.ctrl.get();""!==i&&-1!==i&&(e=parent._.map(i.split(/,/),function(e){return Attachment.get(e)})),t.reset(e)}}),wp.media.view.MediaFrame.MPHBGallery=wp.media.view.MediaFrame.Post.extend({createStates:function(){this.options;this.states.add([new wp.media.controller.MPHBGallery])},bindHandlers:function(){wp.media.view.MediaFrame.Select.prototype.bindHandlers.apply(this,arguments),this.on("toolbar:create:main-insert",this.createToolbar,this);var e={content:{embed:"embedContent","edit-selection":"editSelectionContent"},toolbar:{"main-insert":"mainInsertToolbar"}};parent._.each(e,function(e,t){parent._.each(e,function(e,i){this.on(t+":render:"+i,this[e],this)},this)},this)},mainInsertToolbar:function(e){var t=this;this.selectionStatusToolbar(e),e.set("insert",{style:"primary",priority:80,text:MPHB.Plugin.myThis.data.translations.addGalleryToRoomType,requires:{selection:!0},click:function(){var e=t.state(),i=e.get("selection");t.close(),e.trigger("insert",i).reset()}})}}),this.frame=new wp.media.view.MediaFrame.MPHBGallery(parent._.defaults({},{state:"mphb-media-library-gallery",library:{type:"image"},multiple:!0})),this.frame.on("open",this.proxy("onOpen")),this.frame.on("insert",this.proxy("setImage"))},open:function(e){this.ctrl=e,this.frame.open()},onOpen:function(){var e=this.frame;e.reset();var t=this.ctrl.getArray();if(t.length){var i=null;t.forEach(function(t){i=wp.media.attachment(t),i.fetch(),e.state().get("selection").add(i)})}},setImage:function(){var t=[],i=this.frame.state().get("selection").models;e.each(i,function(e,i){var r=i.attributes;t.push(r.id)}),this.ctrl.set(t.join(","))}}),MPHB.Ctrl=can.Control.extend({},{parentForm:null,init:function(e,t){this.parentForm=this.element.closest("form")}}),MPHB.GalleryCtrl=MPHB.Ctrl.extend({},{input:null,previewHolder:null,addGalleryBtn:null,removeGalleryBtn:null,init:function(e,t){this._super(e,t),this.input=this.element.find("input[type=hidden]"),this.previewHolder=this.element.find("img").on("click",this.proxy("organizeGallery")),this.addGalleryBtn=this.element.find(".mphb-admin-organize-gallery-add").on("click",this.proxy("organizeGallery")),this.removeGalleryBtn=this.element.find(".mphb-admin-organize-gallery-remove").on("click",this.proxy("removeGallery"))},get:function(){return this.input.val()},getArray:function(){var e=this.get();return""!==e?this.get().split(/,/):[]},set:function(e){this.input.val(e),this.updatePreview(),this.updateBtnsVisibility()},updateBtnsVisibility:function(){var e=this.get();""!==e?(this.removeGalleryBtn.removeClass("mphb-hide"),this.addGalleryBtn.addClass("mphb-hide")):(this.removeGalleryBtn.addClass("mphb-hide"),this.addGalleryBtn.removeClass("mphb-hide"))},updatePreview:function(){var e=this.get();if(""!==e){var t=e.split(",").shift(),i=wp.media.attachment(t),r=i.attributes.sizes.medium.url;this.previewHolder.removeClass("mphb-hide").attr("src",r)}else this.previewHolder.addClass("mphb-hide").attr("src","")},organizeGallery:function(e){e.preventDefault(),MPHB.WPGallery.getInstance().open(this)},removeGallery:function(e){e.preventDefault(),this.set("")}}),MPHB.DatePickerCtrl=MPHB.Ctrl.extend({},{input:null,dateFormat:"mm/dd/yyyy",init:function(e,t){this._super(e,t);var i=this;this.input=this.element.find("input");var r=this.input.is("[data-multiple]");this.input.datepick({dateFormat:i.dateFormat,showSpeed:0,showOtherMonths:!0,multiSelect:r?999:0,monthsToShow:3,multiSeparator:","})}}),MPHB.ColorPickerCtrl=MPHB.Ctrl.extend({},{input:null,init:function(e,t){this._super(e,t),this.input=this.element.find("input"),this.input.spectrum({allowEmpty:!0,preferredFormat:"hex",showInput:!0,showInitial:!0,showAlpha:!1})}}),MPHB.ComplexCtrl=MPHB.Ctrl.extend({},{prototypeItem:null,itemsHolder:null,lastIndex:null,uniqid:null,itemSelector:"tr",metaName:null,init:function(e,t){this._super(e,t),this.uniqid=this.element.children("table").attr("data-uniqid"),this.metaName=this.element.children('input[type="hidden"]:first-of-type').attr("name"),this.initItemsHolder(),this.initAddBtn(),this.initDeleteBtns(),this.preparePrototypeItem(),this.initLastIndex(),this.setKeys(this.itemsHolder.children(this.itemSelector))},makeItemsHolderSortable:function(){this.itemsHolder.sortable()},initLastIndex:function(){this.lastIndex=this.itemsHolder.children(this.itemSelector).length-1},initItemsHolder:function(){this.itemsHolder=this.element.children("table").children("tbody"),this.itemsHolder.hasClass("mphb-sortable")&&this.makeItemsHolderSortable()},initAddBtn:function(){var e=this;this.element.on("click",'.mphb-complex-add-item[data-id="'+this.uniqid+'"]',function(t){e.addItem()})},initDeleteBtns:function(){var t=this;this.itemsHolder.on("click",'.mphb-complex-delete-item[data-id="'+this.uniqid+'"]',function(i){t.deleteItem(e(this).closest(t.itemSelector))})},preparePrototypeItem:function(){var t=this.itemsHolder.children(".mphb-complex-item-prototype");this.prototypeItem=t.clone(),this.prototypeItem.removeClass("mphb-hide mphb-complex-item-prototype").find("[name]").each(function(){e(this).removeAttr("disabled")}),t.remove()},getIncIndex:function(){return++this.lastIndex},setKeys:function(t){var i,r,n,a,s,l=this,o=new RegExp("%key_"+this.uniqid+"%","g"),h="%key_"+this.uniqid+"%";t.each(function(t,d){s=e(d),a=s.attr("data-id"),a===h&&(a=l.getIncIndex(),s.attr("data-id",a)),s.find('[name*="[%key_'+l.uniqid+'%]"]').each(function(){i=e(this).attr("name").replace(o,a),e(this).attr("name",i),e(this).attr("id")&&(r=e(this).attr("id").replace(o,a).replace(/\[|\]/g,"__"),e(this).attr("name",i).attr("id",r))}),s.find('[for*="[%key_'+l.uniqid+'%]"]').each(function(){n=e(this).attr("for").replace(o,a).replace(/\[|\]/g,"__"),e(this).attr("for",n)})})},clonePrototypeItem:function(){var e=this.prototypeItem.clone();return this.setKeys(e),e},addItemToHolder:function(e){this.itemsHolder.append(e)},deleteItem:function(e){e.remove()},addItem:function(){var e=this.clonePrototypeItem();this.addItemToHolder(e);var t=e.find(".mphb-ctrl:not([data-inited])");MPHB.Plugin.myThis.setControls(t)}}),MPHB.ComplexVerticalCtrl=MPHB.ComplexCtrl.extend({},{itemSelector:"tbody",lastIndexInput:null,minItemsCount:0,init:function(e,t){this._super(e,t),this.minItemsCount=this.itemsHolder.attr("data-min-items-count")},initLastIndex:function(){this.lastIndexInput=this.itemsHolder.find(">tfoot .mphb-complex-last-index"),this.lastIndex=this.lastIndexInput.val()},getIncIndex:function(){var e=this._super();return this.lastIndexInput.val(e),e},initItemsHolder:function(){this.itemsHolder=this.element.children("table")},addItemToHolder:function(e){this.itemsHolder.children("tfoot").before(e)},disableDeleteButtons:function(){var e=this.itemsHolder.children(this.itemSelector).children(".mphb-complex-item-actions-holder").find(".mphb-complex-delete-item");e.attr("disabled","disabled").addClass("mphb-hide")},enableDeleteButtons:function(){var e=this.itemsHolder.children(this.itemSelector).children(".mphb-complex-item-actions-holder").find(".mphb-complex-delete-item");e.removeAttr("disabled").removeClass("mphb-hide")},updateItemActions:function(){var e=this.itemsHolder.children(this.itemSelector).length;e<=this.minItemsCount?this.disableDeleteButtons():this.enableDeleteButtons()},updateDefaultItem:function(){var e=this.itemsHolder.children(this.itemSelector).find('>.mphb-complex-item-actions-holder [name="'+this.metaName+'[default]"]');e.filter(":checked").length||e.first().attr("checked","checked")},deleteItem:function(e){this._super(e),this.updateItemActions(),this.updateDefaultItem()},addItem:function(){this._super(),this.updateItemActions(),this.updateDefaultItem()}}),MPHB.TotalPriceCtrl=MPHB.Ctrl.extend({},{preloader:null,input:null,init:function(e,t){this._super(e,t),this.input=this.element.find("input"),this.recalculateBtn=this.element.find("#mphb-recalculate-total-price"),this.errorsWrapper=this.element.find(".mphb-errors-wrapper"),this.preloader=this.element.find(".mphb-preloader")},set:function(e){this.input.val(e)},hideErrors:function(){this.errorsWrapper.empty().addClass("mphb-hide")},"input focus":function(){this.hideErrors()},showError:function(e){this.errorsWrapper.html(e).removeClass("mphb-hide")},"#mphb-recalculate-total-price click":function(t,i){var r=this;this.hideErrors(),this.showPreloader();var n=this.parseFormToJSON();e.ajax({url:MPHB.Plugin.myThis.data.ajaxUrl,type:"GET",dataType:"json",data:{action:"mphb_recalculate_total",mphb_nonce:MPHB.Plugin.myThis.data.nonces.mphb_recalculate_total,formValues:n},success:function(e){e.hasOwnProperty("success")?e.success?r.set(e.data.total):r.showError(e.data.message):r.showError(MPHB.Plugin.myThis.data.translations.errorHasOccured)},error:function(e){r.showError(MPHB.Plugin.myThis.data.translations.errorHasOccured)},complete:function(e){r.hidePreloader()}})},showPreloader:function(){this.recalculateBtn.attr("disabled","disabled"),this.preloader.removeClass("mphb-hide")},hidePreloader:function(){this.recalculateBtn.removeAttr("disabled"),this.preloader.addClass("mphb-hide")},parseFormToJSON:function(){return this.parentForm.serializeJSON()}}),MPHB.DynamicSelectCtrl=MPHB.Ctrl.extend({},{dependencyCtrl:null,ajaxAction:null,ajaxNonce:null,errorsWrapper:null,preloader:null,defaultOption:null,init:function(e,t){this._super(e,t),this.input=this.element.find("select"),this.defaultOption=this.input.find('option[value=""]').clone(),this.errorsWrapper=this.element.find(".mphb-errors-wrapper"),this.preloader=this.element.find(".mphb-preloader"),this.ajaxAction=this.input.attr("data-ajax-action"),this.ajaxNonce=this.input.attr("data-ajax-nonce"),this.initDependencyCtrl()},initDependencyCtrl:function(){var e=this.input.attr("data-dependency");this.dependencyCtrl=this.element.closest("form").find('[name="'+e+'"]');var t=this;this.dependencyCtrl.on("change",function(e){t.updateList()}).on("focus",function(e){t.hideErrors()})},setOptions:function(t){var i=this;this.input.html(this.defaultOption.clone()),e.each(t,function(t,r){i.input.append(e("<option />",{value:t,text:r}))})},updateList:function(){var t=this;this.hideErrors(),this.showPreloader(),this.input.html(this.defaultOption.clone());var i=this.parseFormToJSON();e.ajax({url:MPHB.Plugin.myThis.data.ajaxUrl,type:"GET",dataType:"json",data:{action:t.ajaxAction,mphb_nonce:t.ajaxNonce,formValues:i},success:function(e){e.hasOwnProperty("success")?e.success?t.setOptions(e.data.options):t.showError(e.data.message):t.showError(MPHB.Plugin.myThis.data.translations.errorHasOccured)},error:function(e){t.showError(MPHB.Plugin.myThis.data.translations.errorHasOccured)},complete:function(e){t.hidePreloader()}})},parseFormToJSON:function(){return this.parentForm.serializeJSON()},showPreloader:function(){this.preloader.removeClass("mphb-hide")},hidePreloader:function(){this.preloader.addClass("mphb-hide")},hideErrors:function(){this.errorsWrapper.empty().addClass("mphb-hide")},showError:function(e){this.errorsWrapper.html(e).removeClass("mphb-hide")}}),new MPHB.Plugin,e(function(){e(".mphb-bookings-calendar-wrapper")&&new MPHB.BookingsCalendar(e(".mphb-bookings-calendar-wrapper"))}),MPHB.BookingsCalendar=can.Control.extend({},{filtersForm:null,customPeriodWrapper:null,btnPeriodPrev:null,btnPeriodNext:null,periodEl:null,init:function(e,t){this.filtersForm=this.element.find("#mphb-bookings-calendar-filters"),this.customPeriodWrapper=this.filtersForm.find(".mphb-custom-period-wrapper"),this.btnPeriodPrev=this.filtersForm.find(".mphb-period-prev"),this.btnPeriodNext=this.filtersForm.find(".mphb-period-next"),this.periodEl=this.filtersForm.find("#mphb-bookings-calendar-filter-period"),this.searchDateFromEl=this.filtersForm.find(".mphb-search-date-from"),this.searchDateToEl=this.filtersForm.find(".mphb-search-date-to"),this.initDatepickers()},initDatepickers:function(){var e=this.filtersForm.find(".mphb-datepick");e.datepick()},"#mphb-bookings-calendar-filter-period change":function(t,i){var r=e(t).val();"custom"===r?(this.customPeriodWrapper.removeClass("mphb-hide"),this.btnPeriodNext.addClass("mphb-hide"),this.btnPeriodPrev.addClass("mphb-hide")):(this.customPeriodWrapper.addClass("mphb-hide"),this.btnPeriodNext.removeClass("mphb-hide"),this.btnPeriodPrev.removeClass("mphb-hide"))},"#mphb-booking-calendar-search-room-availability-status change":function(t,i){var r=e(t).val();""===r?(this.searchDateFromEl.addClass("mphb-hide"),this.searchDateToEl.addClass("mphb-hide")):(this.searchDateFromEl.removeClass("mphb-hide"),this.searchDateToEl.removeClass("mphb-hide"))}})}(jQuery);