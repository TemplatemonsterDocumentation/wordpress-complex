!function(n){"use strict";var i={init:function(i,e){function t(){var n=q.closest("form"),i=n.validate({onsubmit:!1});if(i.element(q)){var e=A.find(".tm_banners_grid_widget_banner_id").val(),t=u.val()?u.val().split(","):[],a=k.val()?k.val().split(","):[],l=j.val()?j.val().split(","):[],d=x.val()?x.val().split(","):[];t[e]=window.btoa(q.val()),a[e]=G.val(),l[e]=window.btoa(W.val()),d[e]=window.btoa(B.val()),u.val(t.join()),k.val(a.join()),j.val(l.join()),x.val(d.join()),A.dialog("close"),u.trigger("change")}}function a(){b=c.find(".tm_banners_grid_widget_img_col"),m=b.find(".banner_remove"),p=b.find(".banner_link"),m.on("click",function(){var i=n(this).closest(".tm_banners_grid_widget_img_col").index(),e=f.val().split(","),t=u.val()?u.val().split(","):[],a=k.val()?k.val().split(","):[],l=j.val()?j.val().split(","):[],d=x.val()?x.val().split(","):[];e.splice(i,1),t.splice(i,1),a.splice(i,1),l.splice(i,1),d.splice(i,1),f.val(e.join()),u.val(t.join()),k.val(a.join()),j.val(l.join()),x.val(d.join()),n(this).closest(".tm_banners_grid_widget_img_col").remove(),w.hide().find("input").removeAttr("checked"),0<e.length&&w.eq(e.length-1).show().find("input").eq(0).prop("checked",!0),e.length<bannerGridWidgetAdmin.maxBanners&&o.show(),f.trigger("change")}),p.on("click",function(){var i=n(this).closest(".tm_banners_grid_widget_img_col").index(),e=u.val()?u.val().split(","):[],t=k.val()?k.val().split(","):[],a=j.val()?j.val().split(","):[],l=x.val()?x.val().split(","):[];n(".tm_banners_grid_widget_banner_id").val(i),A.dialog("open"),q.val(e[i]?window.atob(e[i]):""),G.find("option").filter(function(){return void 0!==t[i]&&n(this).val()==t[i]}).prop("selected",!0),W.val(a[i]?window.atob(a[i]):""),B.val(l[i]?window.atob(l[i]):"")})}function l(n,i,e){return _=n.splice(i,1),s=n.slice(0,e),g=n.slice(e),n=s.concat(_).concat(g),n.join()}var d,r,_,s,g,o=e.find(".tm_banners_grid_widget_add_media"),v=e.find(".tm_banners_grid_widget_banners_thumbs"),c=v.find(".tm_banners_grid_widget_banners_thumbs_inner"),b=c.find(".tm_banners_grid_widget_img_col"),m=b.find(".banner_remove"),p=b.find(".banner_link"),h=e.find(".tm_banners_grid_widget_banners_grids"),w=h.find(".tm_banners_grid_widget_banners_grid"),f=e.find(".tm_banners_grid_widget_banners"),u=e.find(".tm_banners_grid_widget_banners_links"),k=e.find(".tm_banners_grid_widget_banners_links_targets"),j=e.find(".tm_banners_grid_widget_banners_titles"),x=e.find(".tm_banners_grid_widget_banners_texts"),A=e.find(".banner_link_wrapper"),q=e.find(".tm_banners_grid_widget_banner_link"),G=e.find(".tm_banners_grid_widget_banner_link_target"),W=e.find(".tm_banners_grid_widget_banner_title"),B=e.find(".tm_banners_grid_widget_banner_text");n.validator.methods.url=function(n,i){return this.optional(i)||/(\/?[\w-]+)(\/[\w-]+)*\/?|(#)|(((http|ftp|https):\/\/)?[\w-]+(\.[\w-]+)+([\w.,@?^=%&amp;:\/~+#-]*[\w@?^=%&amp;\/~+#-])?)/gi.test(n)},b.length<bannerGridWidgetAdmin.maxBanners&&o.show(),0<b.length&&w.eq(b.length-1).show(),o.on("click",function(n){if(i)return void i.open();var i=wp.media.frames.downloadable_file=wp.media({title:bannerGridWidgetAdmin.mediaFrameTitle,multiple:!0});i.on("select",function(){for(var n,e=[],t=f.val()?f.val().split(","):[],l=bannerGridWidgetAdmin.maxBanners-t.length,d=i.state().get("selection").toJSON().slice(0,l),r=0;r<d.length;r++)e[r]=d[r].id,c.append(bannerGridWidgetAdmin.col.replace(/%s/g,d[r].sizes.thumbnail.url));n=t.concat(e),6==n.length&&o.hide(),w.hide().find("input").removeAttr("checked"),w.eq(n.length-1).show().find("input").eq(0).prop("checked",!0),i.detach(),a(),f.val(n.join()).trigger("change")}),i.open()}),A.wrapInner("<form/>").dialog({dialogClass:"wp-dialog",modal:!0,autoOpen:!1,closeOnEscape:!0,buttons:{Add:t,Cancel:function(){A.dialog("close")}}}),a(),c.sortable({distance:2,zIndex:100,disabled:!1,start:function(n,i){d=i.item.index()},update:function(n,i){var e=f.val().split(","),t=u.val()?u.val().split(","):[],a=k.val()?k.val().split(","):[],_=j.val()?j.val().split(","):[],s=x.val()?x.val().split(","):[];r=i.item.index(),f.val(l(e,d,r)),0<t.length&&(t.length<e.length&&(t[e.length]=""),u.val(l(t,d,r))),0<a.length&&(a.length<e.length&&(a[e.length]=""),k.val(l(a,d,r))),0<_.length&&(_.length<e.length&&(_[e.length]=""),j.val(l(_,d,r))),0<s.length&&(s.length<e.length&&(s[e.length]=""),x.val(l(s,d,r))),f.trigger("change")}})}};n("#widgets-right").find("div.widget[id*=tm_banners_grid_widget]").each(function(){i.init("init",n(this))}),n(document).on("widget-updated widget-added",function(n,e){e.is("[id*=tm_banners_grid_widget]")&&i.init(n,e)})}(jQuery);